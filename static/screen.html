<html>
    <head>
        <title>Visionect Digital Signage</title>
        <style media="screen">
            body {
                margin: 0;
            }
            .pixel {
                width: 1px;
                height: 1px;
                position: absolute;
                top: 0;
                left: 0;
            }
            #white {
                background: white;
                left: 1px;
            }
            #black {
                background: black;
            }
        </style>
    </head>
    <body>
        <img />
        <div id="black" class="pixel"></div>
        <div id="white" class="pixel"></div>
        <script charset="utf-8">
            document.addEventListener('DOMContentLoaded', function() {
                var image = document.getElementsByTagName('img')[0],
                    white = document.getElementById('white'),
                    black = document.getElementById('black'),
                    refresh = false,
                    waveform = {{.Waveform}};

                image.onload = function() {
                    render();
                    refresh = true;
                }

                image.src = encodeURIComponent('{{.Selected}}') + '?x={{.X}}&y={{.Y}}&width=' + window.innerWidth + '&height=' + window.innerHeight;

                var render = function() {
                    white.style.left = +!white.offsetLeft+"px";
                    black.style.left = +!black.offsetLeft+"px";

                    if (typeof window.okular != 'undefined') {
                        okular.Setup((waveform == 2 || waveform == 5) ? 4 : 1, 0, 0x100|waveform);
                        //okular.RenderRectangles([{x:0, y:0, width: window.innerWidth, height: window.innerHeight, encoding: (waveform == 2 || waveform == 5) ? 4 : 1, dithering: 0, displayUpdateOptions: 0x100|waveform}]);
                    }
                    console.table({x:0, y:0, width: window.innerWidth, height: window.innerHeight, encoding: (waveform == 2 || waveform == 5) ? 4 : 1, dithering: 0, displayUpdateOptions: 0x100|waveform})
                }

                var preloadImage = new Image;
                preloadImage.onload = function() {
                    image.src = this.src;
                }

                var request = new XMLHttpRequest();

                request.onload = function() {
                    if (request.status >= 200 && request.status < 400){
                        // Success!
                        var data = JSON.parse(request.responseText);

                        if (image.src.indexOf(encodeURIComponent(data.Name)) == -1 || window.innerWidth != image.width || window.innerHeight != image.height) {
                            waveform = data.Waveform;
                            // Preload image in detached DOM
                            preloadImage.src = encodeURIComponent(data.Name) + '?x={{.X}}&y={{.Y}}&width=' + window.innerWidth + '&amp;height=' + window.innerHeight;
                            refresh = false;
                        } else if (data.Waveform != waveform || data.Render) {
                            waveform = data.Waveform;
                            render();
                        }
                    }
                };

                setInterval(function() {
                    if (refresh) {
                        request.open('GET', '/screen', true);
                        request.setRequestHeader('Content-Type', 'application/json');
                        request.send();
                    }
                }, {{.Polling}});
            }, false);
        </script>
    </body>
</html>
